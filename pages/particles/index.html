<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Rainbow</title>
  <link rel="stylesheet" type="text/css" href="importer.min.css">
</head>
<body>
  <div class="wrapper">
    <canvas class="canvas" id="canvas" width="500" height="300">
      Your browser does not support HTML5 Canvas API
    </canvas>
  </div>
  <script src="../../scripts/utils.js"></script>
  <script>
  'use strict'

  function Particles (canvas) {
    // instance data
    this.canvas = canvas
    this.ctx = canvas.getContext('2d')
    this.alpha = 0.6
    this.width = window.innerWidth
    this.height = window.innerHeight
    this.pr = window.devicePixelRatio || 1
    this.particles = []

    this.canvas.width = this.width * this.pr
    this.canvas.height = this.height * this.pr

    this.ctx.scale(this.pr, this.pr)
    this.ctx.globalAlpha = this.alpha
  }

  Particles.prototype.drawImage = function () {
    var _this = this
    var img1 = new Image()
    var img2 = new Image()
    img1.src = '../../img/pikaqiu_01.png'
    img2.src = '../../img/pikaqiu_02.png'

    var count = 0
    img1.onload = function () {
      _this.ctx.drawImage(img1, 0, 0, img1.width, img1.height, 0, 0, img1.width, img1.height)
      count++
      _this.saveData(count)
    }
    img2.onload = function () {
      _this.ctx.drawImage(img2, 0, 0, img2.width, img2.height, 400, 400, img2.width, img2.height)
      count++
      _this.saveData(count)
    }
  }

  Particles.prototype.saveData = function (count) {
    if (count !== 2) {
      return
    }
    var _this = this

    void function loop () {
      _this.draw()
      requestAnimationFrame(function () {
        loop()
      })
    }()
  }

  Particles.prototype.draw = function () {
    var _this = this

    var canvasData = _this.ctx.getImageData(0, 0, _this.canvas.width, _this.canvas.height)
    var particles = []
    var len = canvasData.data.length
    // 只保存100行100列的像素值
    var rows = 100
    var cols = 100
    var cellWidth = parseInt(canvasData.width / cols)
    var cellHeight = parseInt(canvasData.height / rows)
    var idxInDataArr = 0
    var particleOffsetX
    var particleOffsetY
    var data = canvasData.data

    for (var i = 1; i <= cols; i++) {
      for (var j = 1; j <= rows; j++) {
        // 计算第i列j行cell对应RGBA值中R值在data数组中的坐标
        idxInDataArr = ((j * cellHeight - 1) * _this.canvas.width + (i * cellWidth - 1)) * 4
        // 判断R值是否符合要求
        if (data[idxInDataArr] > 250) {
          var particle = {
            // 偏移，x、y都随机一下
            x: 50 + i * cellWidth + (Math.random() - 0.5) * 20,
            y: 50 + j * cellHeight + (Math.random() - 0.5) * 20,
            fillStyle: '#006eff'
          }
          particles.push(particle)
        }
      }
    }

    // _this.ctx.clearRect(0, 0, _this.canvas.width, _this.canvas.height)

    for (var i = 0, len = particles.length; i < len; i++) {
      var curParticle = particles[i]
      _this.ctx.fillStyle = curParticle.fillStyle
      _this.ctx.fillRect(curParticle.x, curParticle.y, 10, 10)
    }
  }

  function canvasSupport () {
    return !!document.createElement('canvas').getContext
  }

  void function launchApp () {
    if (!canvasSupport()) {
      return
    }

    var canvas = document.getElementById('canvas')
    new Particles(canvas).drawImage()
  }()
  </script>
</body>
</html>
