<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Rainbow</title>
  <link rel="stylesheet" type="text/css" href="importer.min.css">
</head>
<body>
  <div class="wrapper">
    <canvas class="canvas" id="canvas" width="500" height="300">
      Your browser does not support HTML5 Canvas API
    </canvas>
  </div>
  <script src="../../scripts/utils.js"></script>
  <script>
  'use strict'

  function Particles (canvas) {
    // instance data
    this.canvas = canvas
    this.ctx = canvas.getContext('2d')
    this.alpha = 0.6
    this.width = window.innerWidth
    this.height = window.innerHeight
    this.pr = window.devicePixelRatio || 1
    this.particles = []

    this.canvas.width = this.width * this.pr
    this.canvas.height = this.height * this.pr

    this.ctx.scale(this.pr, this.pr)
    this.ctx.globalAlpha = this.alpha
  }

  Particles.prototype.drawImage = function () {
    var _this = this
    var img = new Image()
    img.src = '../../img/pikaqiu_01.png'

    img.onload = function () {
      _this.ctx.drawImage(img, 0, 0, img.width, img.height, (_this.canvas.width - img.width) / 2, (_this.canvas.height - img.height) / 2, img.width, img.height)
      _this.saveData()
    }
  }

  Particles.prototype.saveData = function () {
    var _this = this

    var canvasData = _this.ctx.getImageData(0, 0, _this.canvas.width, _this.canvas.height)

    void function loop () {
      _this.draw(canvasData)
      requestAnimationFrame(function () {
        loop()
      })
      // setTimeout(loop, 1000)
    }()
  }

  Particles.prototype.draw = function (canvasData) {
    var _this = this

    var particles = []
    var len = canvasData.data.length
    // 只保存100行100列的像素值
    // var rows = 100
    // var cols = 100
    // var cellWidth = parseInt(canvasData.width / cols)
    // var cellHeight = parseInt(canvasData.height / rows)
    var idxInDataArr = 0
    var particleOffsetX
    var particleOffsetY
    var data = canvasData.data

    _this.ctx.clearRect(0, 0, _this.canvas.width, _this.canvas.height)
    for (var i = 0; i < canvasData.width; i+=6) {
      for (var j = 0; j < canvasData.height; j+=6) {
        // 计算(i, j)坐标上的像素点对应RGBA值中R值在data数组中的索引
        idxInDataArr = (j * canvasData.width + i) * 4
        // 判断R值是否符合要求
        if (data[idxInDataArr + 3] > 50) {
          var distance = (Math.random() - 0.5) * 1
          var particle = {
            // 偏移，x、y都随机一下
            x: i + distance,
            y: j + distance,
            rgba: 'rgba(' + data[idxInDataArr] + ', ' + data[idxInDataArr + 1] + ', ' + data[idxInDataArr + 2] + ', ' + data[idxInDataArr + 3] + ')',
            fillStyle: '#006eff'
          }
          particles.push(particle)
        }
      }
    }

    // _this.ctx.clearRect(0, 0, _this.canvas.width, _this.canvas.height)

    for (var i = 0, len = particles.length; i < len; i++) {
      _this.ctx.save()
      _this.ctx.beginPath()
      var curParticle = particles[i]
      // _this.ctx.fillRect(curParticle.x, curParticle.y, 10, 10)
      _this.ctx.arc(curParticle.x, curParticle.y, 2, 0, Math.PI * 2)
      _this.ctx.fillStyle = curParticle.rgba
      _this.ctx.fill()
      _this.ctx.restore()
    }
  }

  function canvasSupport () {
    return !!document.createElement('canvas').getContext
  }

  void function launchApp () {
    if (!canvasSupport()) {
      return
    }

    var canvas = document.getElementById('canvas')
    new Particles(canvas).drawImage()
  }()
  </script>
</body>
</html>
